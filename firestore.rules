rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions to keep rules clean ---
    
    // Check if the user is signed in
    function isSignedIn() {
      return request.auth != null;
    }

    // Check if the user is accessing their own document (for 'users' collection)
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Check if the data being created/updated belongs to the user (for root collections)
    function isResourceOwner() {
      return isSignedIn() && (
        // For CREATE: Check the 'userId' field in the incoming data
        (request.method == 'create' && request.resource.data.userId == request.auth.uid) ||
        // For UPDATE/DELETE: Check the 'userId' field in the existing data
        (request.method != 'create' && resource.data.userId == request.auth.uid)
      );
    }

    // --- Collection Rules ---

    // 1. User Profiles (Key is the User ID)
    // Matches /users/{userId}
    match /users/{userId} {
      // Only the user can read or write their own profile
      allow read, write: if isOwner(userId);
    }

    // 2. Workout Plans (Generated by AI)
    match /workout_plans/{document=**} {
      allow read: if resource.data.userId == request.auth.uid;
      allow create: if request.resource.data.userId == request.auth.uid;
      allow update, delete: if resource.data.userId == request.auth.uid;
    }

    // 3. Workout Logs (Your Dashboard Stats)
    match /workout_logs/{document=**} {
      allow read: if resource.data.userId == request.auth.uid;
      allow create: if request.resource.data.userId == request.auth.uid;
      allow update, delete: if resource.data.userId == request.auth.uid;
    }

    // 4. Nutrition/Recipes (Saved Meals)
    // Assuming you might add a 'nutrition_logs' or similar collection based on your plan
    match /nutrition_logs/{document=**} {
      allow read: if resource.data.userId == request.auth.uid;
      allow create: if request.resource.data.userId == request.auth.uid;
      allow update, delete: if resource.data.userId == request.auth.uid;
    }

    // 5. User Progress (Weight, Body Fat, etc.)
    match /user_progress/{document=**} {
      allow read: if resource.data.userId == request.auth.uid;
      allow create: if request.resource.data.userId == request.auth.uid;
      allow update, delete: if resource.data.userId == request.auth.uid;
    }
    
    // 6. User Favorites
    match /user_favorites/{document=**} {
      allow read: if resource.data.userId == request.auth.uid;
      allow create: if request.resource.data.userId == request.auth.uid;
      allow update, delete: if resource.data.userId == request.auth.uid;
    }

    // Block everything else by default (Safe Fallback)
    match /{document=**} {
      allow read, write: if false;
    }
  }
}