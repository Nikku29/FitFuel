rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isValidImageType() {
      return request.resource.contentType.matches('image/.*');
    }
    
    function isValidVideoType() {
      return request.resource.contentType.matches('video/.*');
    }
    
    function isValidMediaType() {
      return isValidImageType() || isValidVideoType();
    }
    
    function isValidFileSize(maxSize) {
      return request.resource.size <= maxSize;
    }
    
    // User uploads - organized by user ID
    match /user_uploads/{userId}/{allPaths=**} {
      allow read: if isAuthenticated() && isOwner(userId);
      allow write: if isAuthenticated() && 
                     isOwner(userId) && 
                     isValidMediaType() && 
                     isValidFileSize(10 * 1024 * 1024); // 10MB limit
    }
    
    // User avatars - special handling for profile pictures
    match /user_uploads/{userId}/avatar/{fileName} {
      allow read: if true; // Profile pictures can be publicly readable
      allow write: if isAuthenticated() && 
                     isOwner(userId) && 
                     isValidImageType() && 
                     isValidFileSize(5 * 1024 * 1024); // 5MB limit for avatars
    }
    
    // Workout media uploads
    match /user_uploads/{userId}/workouts/{workoutId}/{fileName} {
      allow read, write: if isAuthenticated() && 
                           isOwner(userId) && 
                           isValidMediaType() && 
                           isValidFileSize(50 * 1024 * 1024); // 50MB limit for workout videos
    }
    
    // Recipe image uploads
    match /user_uploads/{userId}/recipes/{recipeId}/{fileName} {
      allow read, write: if isAuthenticated() && 
                           isOwner(userId) && 
                           isValidImageType() && 
                           isValidFileSize(10 * 1024 * 1024); // 10MB limit for recipe images
    }
    
    // Public media (workout templates, recipe images, etc.)
    match /public_media/{allPaths=**} {
      allow read: if true; // Public read access
      allow write: if false; // Only Cloud Functions or admin can write
    }
    
    // Temporary uploads (for processing)
    match /temp_uploads/{userId}/{fileName} {
      allow read, write: if isAuthenticated() && 
                           isOwner(userId) && 
                           isValidMediaType() && 
                           isValidFileSize(100 * 1024 * 1024); // 100MB limit for temp files
      // These files should be automatically cleaned up after processing
    }
    
    // Thumbnails - generated automatically
    match /thumbnails/{allPaths=**} {
      allow read: if true; // Public read access for thumbnails
      allow write: if false; // Only Cloud Functions can generate thumbnails
    }
  }
}